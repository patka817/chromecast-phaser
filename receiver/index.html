<!DOCTYPE html>
<html>

<head>
	<title>chromecast-Breakout</title>
</head>
<link rel="stylesheet" type="text/css" href="css/style.css">

<body>
	<div id="nes-wrapper" class="nes-wrapper">
		<video id='videoStream' autoplay width='100%' height='100%'></video>
	</div>
</body>
<script src="//www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
<script src="js/peerjs.min.js"></script>
<script>
	const namespace = 'urn:x-cast:se.patrikkarlsson.cast.snes-cast';
	let myPeer;
	let mainCastSenderId;
	let remotePeerConnected = false;
	let mediaConnection;
	let context;

	let video = document.getElementById('videoStream');

	window.onload = function () {
		const initialize = () => {
			console.log('initializing peer');
			myPeer = new Peer();
			myPeer.on('open', onOpen);
			myPeer.on('call', onCall);
			myPeer.on('close', onClose);
			myPeer.on('disconnected', onDisconnected);
			myPeer.on('error', onError);
			myPeer.connect();

			console.log('initializing cast');
			const options = new cast.framework.CastReceiverOptions();
			options.disableIdleTimeout = true;

			context = cast.framework.CastReceiverContext.getInstance();
			
			context.setLoggerLevel(cast.framework.LoggerLevel.DEBUG);
			context.addCustomMessageListener(namespace, onCustomMessage);

			context.addEventListener(cast.framework.events.EventType.SENDER_CONNECTED, onSenderConnected);
			context.addEventListener(cast.framework.events.EventType.READY, onCastReady);

			context.start(options);
		};

		const onCastReady = (event) => {
			findLaunchingSenderId();
		};

		const findLaunchingSenderId = () => {
			if (!mainCastSenderId && cast.framework.system.launchingSenderId) {
				mainCastSenderId = cast.framework.system.launchingSenderId;
				console.log('main cast sender: ' + mainCastSenderId);
			} else if (!mainCastSenderId) {
				console.log('unable to find launching sender id');
			}
		}

		const onCall = (connection) => {
			if (mediaConnection) {
				mediaConnection.close();
			}
			mediaConnection = connection;
			mediaConnection.on('stream', onStream);
			// todo: handle disconnect/error events
			mediaConnection.answer();
		};

		const onStream = (stream) => {
			video.srcObject = stream;
		};

		const onOpen = (id) => {
			console.log('Connected to Peer-server with id: ' + id);
			findLaunchingSenderId();
			trySendingPeerId();
		};

		const onClose = () => {
			console.log('Closed');
			myPeer.destroy();
		};

		const onDisconnected = () => {
			console.log('disconnected');
			if (!remotePeerConnected) {
				myPeer.reconnect();
			}
		};

		const onError = error => {
			console.log(error);
		};

		const onSenderConnected = (event) => {
			console.log(event);
			mainCastSenderId = event.senderID;
			trySendingPeerId();
		};

		const onSenderDisconnected = (event) => {
			console.log('sender disconnected');
			console.log(event);
			if (mainCastSenderId && event.senderID === mainCastSenderId) {
				mainCastSenderId = undefined;
			}
		}

		const trySendingPeerId = (senderId = undefined) => {
			console.log('trying to send local peer id');
			if (myPeer.id && !remotePeerConnected) {
				sendCustomMessage({ type: 'castPeerId', peerId: myPeer.id }, senderId);
			} else {
				console.log('Failed to send local peer id...');
			}
		};

		function onCustomMessage(event) {
			if (event.data.type == 'sendPeerId') {
				console.log('Recieved request for sending local peer id from sender with id: ' + event.senderId)
				trySendingPeerId(event.senderId);
			} else if (event.data.type == 'ping') {
				console.log('Got pinged!');
			} else if (event.data.type === 'LC') {
				sendCustomMessage(event.data, event.senderId);
			}
		}

		const sendCustomMessage = (payload, senderId = undefined) => {
			const id = senderId ? senderId : mainCastSenderId;
			if (context && id) {
				context.sendCustomMessage(namespace, id, payload);
			}
		};

		initialize();
	};
</script>

</html>